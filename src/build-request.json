{
  "kind": "build_request",
  "title": "Fix internal registration overwrite bug (unique INT IDs + CUSTOMER_SERVICE consistency)",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Update `backend/main.mo` `registerInternalUser(role, name, email, whatsapp)` to generate a unique internal user ID that does not depend on the caller Principal (replace any `\"INT-\" # caller.toText()` strategy). Use an internal counter-based strategy so a single SUPERADMIN can register multiple internal users without overwriting entries in `userProfilesById`.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Bug sumbernya ada di backend/main.mo pada fungsi registerInternalUser yang membuat userId = \"INT-\" + caller principal",
          "GANTI total strategi ID ini menjadi ID unik berbasis counter internal (paling aman)"
        ]
      },
      "acceptanceCriteria": [
        "Calling `registerInternalUser(...)` multiple times from the same SUPERADMIN results in different returned IDs each time.",
        "`userProfilesById` contains one distinct entry per internal registration; no registration silently replaces an existing entry keyed by the same userId.",
        "The generated internal ID format remains `INT-<number>` (counter-based), not `INT-<principal>`."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Ensure the internal ID counter used by `registerInternalUser` remains safe across canister upgrades so it does not reset to a value that could collide with existing `INT-*` IDs already stored in `userProfilesById`. If an upgrade/migration step is necessary under current state persistence, add the minimal conditional migration to preserve or recompute the counter from existing stored profiles.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "ID harus unik untuk setiap internal user yang didaftarkan",
          "Pastikan tidak ada kemungkinan overwrite di userProfilesById."
        ]
      },
      "acceptanceCriteria": [
        "After a canister upgrade, a new `registerInternalUser(...)` call produces an `INT-*` ID that does not already exist in `userProfilesById`.",
        "No existing `UserProfile` records are modified as part of this change (only the counter/state needed for ID generation)."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Add a minimal safety guard in `registerInternalUser` to prevent silent overwrite in `userProfilesById`: if the newly generated `userId` already exists in `userProfilesById`, the function must not overwrite the existing profile (e.g., retry generating the next counter value until free, or trap with a clear error).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Tambahkan guard kecil agar tidak overwrite byId secara diam-diam: Jika userProfilesById.get(userId) sudah ada (should not happen setelah counter), tetap aman."
        ]
      },
      "acceptanceCriteria": [
        "If a generated `userId` is already present in `userProfilesById`, the implementation does not call `userProfilesById.add(userId, ...)` with a different profile for that key.",
        "The behavior in the collision case is deterministic and safe (either retries to a free ID or traps)."
      ]
    },
    {
      "id": "REQ-4",
      "text": "Keep `registerInternalUser` authorization exactly as it currently is: it must remain callable only by a caller whose existing profile role is `SUPERADMIN`, and anonymous callers must be rejected.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Pastikan registerInternalUser hanya bisa dipanggil oleh SUPERADMIN seperti aturan sekarang."
        ]
      },
      "acceptanceCriteria": [
        "Anonymous callers cannot register internal users.",
        "A non-SUPERADMIN caller cannot register internal users.",
        "A SUPERADMIN caller can still register internal users as before, except now IDs do not overwrite."
      ]
    },
    {
      "id": "REQ-5",
      "text": "Make `CUSTOMER_SERVICE` handling fully consistent with other internal roles in backend registration and returned/listed data: when `registerInternalUser` is called with role `CUSTOMER_SERVICE`, it must create the same `UserProfile` structure as other internal roles (role preserved as `CUSTOMER_SERVICE`, status `#pending`, stored in both `userProfilesById` and `userProfilesByPrincipal`). Remove/avoid any special-case DTO or list/return path that causes CUSTOMER_SERVICE users to lose role information or be treated differently from other internal roles.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Pastikan CUSTOMER_SERVICE diperlakukan sama seperti internal role lain",
          "Jangan membuat jalur DTO khusus yang menyebabkan CS berbeda perlakuan saat login/approval. Jika ada type/DTO khusus CustomerServiceUserDTO yang tidak membawa role, pastikan fungsi list/return data untuk CS tetap menggunakan data yang bersumber dari UserProfile dan role tetap dapat dikenali sebagai \"CUSTOMER_SERVICE\"."
        ]
      },
      "acceptanceCriteria": [
        "Registering an internal user with role `CUSTOMER_SERVICE` stores a `UserProfile` whose `role == \"CUSTOMER_SERVICE\"`, `status == #pending`, and `internalData` is set (same shape as other internal roles).",
        "Any backend method(s) that return customer service user records include enough information to correctly identify role as `CUSTOMER_SERVICE` from `UserProfile` (no loss of role due to a specialized DTO path).",
        "CUSTOMER_SERVICE remains present in both `validRoles` and `internalRoles` (no removal or renaming)."
      ]
    }
  ],
  "constraints": [
    "Backend changes only: limit modifications to `backend/main.mo` logic for internal ID generation in `registerInternalUser`, and consistency of persistence in `userProfilesById` / `userProfilesByPrincipal`, plus any minimal conditional migration strictly required to prevent ID collisions after upgrade.",
    "Do not change routing, pages, or any frontend/UI code.",
    "Do not add new features.",
    "Do not add new fields to `UserProfile`.",
    "Do not create new roles or new statuses."
  ],
  "nonGoals": [
    "Refactoring unrelated backend modules (services, tasks, layananku, wallets, audit logs).",
    "Changing internal login UI behavior or any frontend role cards.",
    "Adding new registration flows or adding a target principal parameter to `registerInternalUser` (signature changes not requested).",
    "Introducing new DTO concepts beyond what is minimally required to keep CUSTOMER_SERVICE role recognizable and consistent."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}