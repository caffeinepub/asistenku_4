{
  "kind": "build_request",
  "title": "Unify internal user approval flow using existing internalRoles and merge CS approvals into main list",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Backend: Refactor internal approval querying to use the existing `internalRoles` Set already defined in `backend/main.mo` at line 458 as the only source of truth for determining which roles are “internal” for approval purposes; do not create any new role set/variable for this purpose.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Build patchnya. Pastikan implementasi backend menggunakan variabel internalRoles yang sudah ada di main.mo baris 458 untuk query approval, jangan membuat variabel baru."
        ]
      },
      "acceptanceCriteria": [
        "Code compiles with no new internal-role set/variable introduced for approval filtering (the existing `internalRoles` at main.mo line 458 is used).",
        "Any approval-related filter that checks whether a user is internal uses `internalRoles.contains(normalizeRole(role))` (or equivalent) referencing the existing `internalRoles` binding."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Backend: Implement a unified pending-approval query for internal users that returns ONLY users whose `role` is contained in the existing `internalRoles` Set and whose `status` is `pending`, with no role-specific branching (e.g., no separate handling for CUSTOMER_SERVICE or FINANCE).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Build patchnya. Pastikan implementasi backend menggunakan variabel internalRoles yang sudah ada di main.mo baris 458 untuk query approval, jangan membuat variabel baru."
        ]
      },
      "acceptanceCriteria": [
        "A single backend method exists to fetch pending internal users, and it filters by (role ∈ internalRoles) AND (status == pending).",
        "The method does not create or depend on any separate per-role pending lists/queries (including CUSTOMER_SERVICE)."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Backend: Ensure the internal-user approval action is role-agnostic for any role contained in `internalRoles` and, when an internal user is approved, their `UserProfile.status` is updated to `active` immediately (no special-casing for specific internal roles).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Build patchnya. Pastikan implementasi backend menggunakan variabel internalRoles yang sudah ada di main.mo baris 458 untuk query approval, jangan membuat variabel baru."
        ]
      },
      "acceptanceCriteria": [
        "Approving a pending internal user with role in `internalRoles` results in their profile status being persisted as `active` immediately.",
        "There is no approval code path that behaves differently for CUSTOMER_SERVICE vs other internal roles."
      ]
    },
    {
      "id": "REQ-4",
      "text": "Frontend (Superadmin dashboard): Remove the separate “Customer Service Users” list and merge CUSTOMER_SERVICE users into the main internal user management flow so that pending approvals for CUSTOMER_SERVICE appear in the same “Internal Approval (Pending)” table and the same internal users list as other internal roles.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Build patchnya. Pastikan implementasi backend menggunakan variabel internalRoles yang sudah ada di main.mo baris 458 untuk query approval, jangan membuat variabel baru."
        ]
      },
      "acceptanceCriteria": [
        "`frontend/src/components/superadmin/UserManagementView.tsx` no longer renders a separate “Customer Service Users” section/card.",
        "Pending CUSTOMER_SERVICE users appear in the same “Internal Approval (Pending)” table as other internal roles.",
        "Approving/rejecting a CUSTOMER_SERVICE user uses the same approve/reject action wiring as other internal roles (no separate CS flow)."
      ]
    },
    {
      "id": "REQ-5",
      "text": "Frontend (Status refresh): Add lightweight automatic refresh for the current user profile query so that when an internal user’s backend status changes (e.g., `pending` → `active` after approval), the UI updates without requiring a manual refresh (polling is acceptable).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Build patchnya. Pastikan implementasi backend menggunakan variabel internalRoles yang sudah ada di main.mo baris 458 untuk query approval, jangan membuat variabel baru."
        ]
      },
      "acceptanceCriteria": [
        "The React Query for the caller profile (`useGetCallerUser` in `frontend/src/hooks/useQueries.ts`) automatically refetches on an interval (e.g., 5–10 seconds) when appropriate.",
        "After a superadmin approves an internal user, that user’s profile/status UI updates from pending to active automatically without a full page reload."
      ]
    }
  ],
  "constraints": [
    "Use English for any user-facing text.",
    "Backend must use the existing `internalRoles` variable already defined in `backend/main.mo` at line 458 for approval queries/filters; do not introduce a new internal-role set/variable.",
    "Respect the single-actor backend architecture (all Motoko logic stays in `backend/main.mo`).",
    "Do not edit files under `frontend/src/components/ui` or other immutable paths listed in SYSTEM_CONTEXT."
  ],
  "nonGoals": [
    "Do not change the internal registration form behavior/fields.",
    "Do not change role definitions or add/remove roles.",
    "Do not change the access code system.",
    "Do not implement real-time via WebSockets or any push-based mechanism."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}